<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Clés - Importation Excel</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .import-section {
            margin-bottom: 30px;
        }

        .import-steps {
            display: flex;
            margin-bottom: 20px;
        }

        .import-step {
            flex: 1;
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin: 0 5px;
        }

        .import-step.active {
            background-color: #3498db;
            color: white;
        }

        .import-step.completed {
            background-color: #2ecc71;
            color: white;
        }

        .preview-table {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .mapping-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mapping-item {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .mapping-item select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .progress-container {
            width: 100%;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 20px;
            background-color: #3498db;
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-logo">
                <i class="fas fa-key"></i> Gestion des Clés
            </a>
            <ul class="navbar-menu">
                <li class="navbar-item"><a href="index.html" class="navbar-link">Accueil</a></li>
                <li class="navbar-item"><a href="cles.html" class="navbar-link active">Clés</a></li>
                <li class="navbar-item"><a href="armoires.html" class="navbar-link">Armoires</a></li>
                <li class="navbar-item"><a href="prets.html" class="navbar-link">Prêts</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <h1>Importation des Clés depuis Excel</h1>

        <div class="card">
            <div class="import-section">
                <div class="import-steps">
                    <div class="import-step active" id="step-upload">
                        <i class="fas fa-upload"></i>
                        <div>Téléchargement</div>
                    </div>
                    <div class="import-step" id="step-preview">
                        <i class="fas fa-eye"></i>
                        <div>Prévisualisation</div>
                    </div>
                    <div class="import-step" id="step-mapping">
                        <i class="fas fa-exchange-alt"></i>
                        <div>Mappage</div>
                    </div>
                    <div class="import-step" id="step-import">
                        <i class="fas fa-file-import"></i>
                        <div>Importation</div>
                    </div>
                    <div class="import-step" id="step-complete">
                        <i class="fas fa-check-circle"></i>
                        <div>Terminé</div>
                    </div>
                </div>

                <!-- Step 1: Upload -->
                <div id="upload-section">
                    <div class="card-content">
                        <p>Sélectionnez votre fichier Excel d'inventaire des clés pour commencer l'importation.</p>
                        <p>Formats supportés: .xlsx, .xls</p>
                    </div>
                    <div class="form-group">
                        <input type="file" id="excel-file" class="form-control" accept=".xlsx, .xls">
                    </div>
                    <button id="upload-btn" class="btn btn-primary" disabled>
                        <i class="fas fa-upload"></i> Télécharger et Prévisualiser
                    </button>
                </div>

                <!-- Step 2: Preview -->
                <div id="preview-section" class="hidden">
                    <div class="card-content">
                        <p>Prévisualisation des données. Vérifiez que les données sont correctement chargées avant de continuer.</p>
                    </div>
                    <div class="preview-table">
                        <table class="table" id="preview-table">
                            <thead>
                                <tr id="preview-header"></tr>
                            </thead>
                            <tbody id="preview-body"></tbody>
                        </table>
                    </div>
                    <button id="back-to-upload-btn" class="btn btn-warning">
                        <i class="fas fa-arrow-left"></i> Retour
                    </button>
                    <button id="continue-to-mapping-btn" class="btn btn-primary">
                        <i class="fas fa-arrow-right"></i> Continuer vers le Mappage
                    </button>
                </div>

                <!-- Step 3: Mapping -->
                <div id="mapping-section" class="hidden">
                    <div class="card-content">
                        <p>Associez les colonnes de votre fichier Excel aux champs de l'application.</p>
                    </div>
                    <div class="mapping-container" id="mapping-container">
                        <!-- Mapping fields will be generated here -->
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Assurez-vous que tous les champs obligatoires sont correctement mappés.
                    </div>
                    <button id="back-to-preview-btn" class="btn btn-warning">
                        <i class="fas fa-arrow-left"></i> Retour
                    </button>
                    <button id="continue-to-import-btn" class="btn btn-primary">
                        <i class="fas fa-arrow-right"></i> Continuer vers l'Importation
                    </button>
                </div>

                <!-- Step 4: Import -->
                <div id="import-section" class="hidden">
                    <div class="card-content">
                        <p>Prêt à importer les données. Cliquez sur le bouton ci-dessous pour commencer l'importation.</p>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="import-progress"></div>
                    </div>
                    <div id="import-status"></div>
                    <button id="back-to-mapping-btn" class="btn btn-warning">
                        <i class="fas fa-arrow-left"></i> Retour
                    </button>
                    <button id="start-import-btn" class="btn btn-primary">
                        <i class="fas fa-file-import"></i> Démarrer l'Importation
                    </button>
                </div>

                <!-- Step 5: Complete -->
                <div id="complete-section" class="hidden">
                    <div class="card-content">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> Importation terminée avec succès!
                        </div>
                        <p>Résumé de l'importation:</p>
                        <ul id="import-summary"></ul>
                    </div>
                    <button id="view-keys-btn" class="btn btn-primary">
                        <i class="fas fa-list"></i> Voir les Clés Importées
                    </button>
                    <button id="new-import-btn" class="btn btn-warning">
                        <i class="fas fa-redo"></i> Nouvelle Importation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>Application de Gestion des Clés pour Collectivité © 2025</p>
    </footer>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="import-client.js"></script>
    <script>
        // DOM Elements
        const excelFileInput = document.getElementById('excel-file');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadSection = document.getElementById('upload-section');
        const previewSection = document.getElementById('preview-section');
        const mappingSection = document.getElementById('mapping-section');
        const importSection = document.getElementById('import-section');
        const completeSection = document.getElementById('complete-section');
        
        const previewHeader = document.getElementById('preview-header');
        const previewBody = document.getElementById('preview-body');
        const mappingContainer = document.getElementById('mapping-container');
        const importProgress = document.getElementById('import-progress');
        const importStatus = document.getElementById('import-status');
        const importSummary = document.getElementById('import-summary');
        
        const backToUploadBtn = document.getElementById('back-to-upload-btn');
        const continueToMappingBtn = document.getElementById('continue-to-mapping-btn');
        const backToPreviewBtn = document.getElementById('back-to-preview-btn');
        const continueToImportBtn = document.getElementById('continue-to-import-btn');
        const backToMappingBtn = document.getElementById('back-to-mapping-btn');
        const startImportBtn = document.getElementById('start-import-btn');
        const viewKeysBtn = document.getElementById('view-keys-btn');
        const newImportBtn = document.getElementById('new-import-btn');

        // Step indicators
        const stepUpload = document.getElementById('step-upload');
        const stepPreview = document.getElementById('step-preview');
        const stepMapping = document.getElementById('step-mapping');
        const stepImport = document.getElementById('step-import');
        const stepComplete = document.getElementById('step-complete');

        // Global variables
        let excelData = null;
        let headers = [];
        let mappings = {};
        
        // Required fields for the keys table
        const requiredFields = [
            { id: 'key_name', label: 'Nom de la clé', description: 'Identifiant unique de la clé' },
            { id: 'quantity', label: 'Quantité', description: 'Nombre total de clés disponibles' }
        ];
        
        // Optional fields for the keys table
        const optionalFields = [
            { id: 'location', label: 'Emplacement', description: 'Emplacement de stockage de la clé' },
            { id: 'status', label: 'Statut', description: 'Statut actuel de la clé (disponible, prêtée, etc.)' },
            { id: 'description', label: 'Description', description: 'Description supplémentaire de la clé' }
        ];

        // Event Listeners
        excelFileInput.addEventListener('change', handleFileSelect);
        uploadBtn.addEventListener('click', handleUpload);
        backToUploadBtn.addEventListener('click', goToUploadStep);
        continueToMappingBtn.addEventListener('click', goToMappingStep);
        backToPreviewBtn.addEventListener('click', goToPreviewStep);
        continueToImportBtn.addEventListener('click', goToImportStep);
        backToMappingBtn.addEventListener('click', goToMappingStep);
        startImportBtn.addEventListener('click', startImport);
        viewKeysBtn.addEventListener('click', viewImportedKeys);
        newImportBtn.addEventListener('click', resetImport);

        // Functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                uploadBtn.disabled = false;
            } else {
                uploadBtn.disabled = true;
            }
        }

        function handleUpload() {
            const file = excelFileInput.files[0];
            if (!file) {
                alert('Veuillez sélectionner un fichier Excel.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get the first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (excelData.length < 2) {
                        alert('Le fichier Excel ne contient pas assez de données.');
                        return;
                    }
                    
                    // Extract headers (first row)
                    headers = excelData[0];
                    
                    // Generate preview
                    generatePreview();
                    
                    // Go to preview step
                    goToPreviewStep();
                } catch (error) {
                    console.error('Error parsing Excel file:', error);
                    alert('Erreur lors de la lecture du fichier Excel. Veuillez vérifier le format du fichier.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function generatePreview() {
            // Clear previous preview
            previewHeader.innerHTML = '';
            previewBody.innerHTML = '';
            
            // Add headers
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                previewHeader.appendChild(th);
            });
            
            // Add data rows (limit to 10 for preview)
            const previewRows = excelData.slice(1, 11);
            previewRows.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach((_, index) => {
                    const td = document.createElement('td');
                    td.textContent = row[index] !== undefined ? row[index] : '';
                    tr.appendChild(td);
                });
                previewBody.appendChild(tr);
            });
        }

        function generateMappingFields() {
            // Clear previous mappings
            mappingContainer.inne<response clipped><NOTE>To save on context only part of this file has been shown to you. You should retry this tool after you have searched inside the file with `grep -n` in order to find the line numbers of what you are looking for.</NOTE>